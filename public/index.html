<!-- index.html -->
<!doctype html>
<html lang="en-US">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<script src="/includes/jquery.min.js" type="text/javascript"></script>
	<script src="/includes/jquery-migrate.min.js" type="text/javascript"></script>
	<script src="/includes/angular.js"></script>
    <script src="/includes/angular-animate.js"></script>
    <script src="/includes/ui-bootstrap-tpls-1.3.2.min.js"></script>
    <script src="core.js"></script>
    <link href="/includes/bootstrap.min.css" rel="stylesheet">
    <link href="/includes/toggle-switch.css" rel="stylesheet">
	<script type="text/javascript" src="/includes/jwplayer/jwplayer.js"></script>
	<script type="text/javascript">jwplayer.key="+rrlB3wprn26V24N1tGu0ATArz7gd0p/Y/e7DJfsBSw=";</script>	
	
	<link rel="stylesheet" href="/includes/style.css" />
</head>

<body>
	<div ng-app="Tau-Subtitles" ng-controller="subtitleTableController">
	<div class="alerts-container">
	 	<uib-alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)" dismiss-on-timeout=2000>{{alert.msg}}</uib-alert>
    </div>

    	<div class="container-fluid input-text-max-width" ng-hide="authenticated">
    		<h1>TAU Sub</h1>
    		<p>Please authenticate:</p>
    		<p>User Name:<input type="text" class="form-control padding-div" ng-model="userId"> </p>
    		<p>Password:<input type="password" class="form-control padding-div" ng-model="userPass"></p>
    		
    		<button class="btn btn-primary padding-div" ng-click="tryToAuthenticate()"> Login </button>
    	</div>

		<div class="container-fluid" ng-show="authenticated">
			  <div class="jumbotron">
			    <h1>TAU Sub</h1>
			    <p><b>Play\Stop</b> - 'ctrl + Enter', <b>Save</b> - 'ctrl + shift + S'</p>
			    <p><b>Add Row</b> - 'ctrl + S' \ Enter , <b>Remove Row</b> - 'ctrl + D' </p>
			    <p><b>Set Start Time</b> - 'ctrl + G', <b>Set Finish Time</b> - 'ctrl + F'</p>
			    <p><b>Faster</b> - 'ctrl + Arrow Up', <b>Slower</b> - 'ctrl + Arrow Down' </p>
			    <p><b>Loop</b> - 'ctrl + L'
			  </div>

	  		<div class="row">
				<div class="col-md-4">
		        </div>				
		        <div class="col-md-1">
		        	<label class="switch-light switch-candy" onclick="">
  						<input type="checkbox" id="loop">
						  <strong>
						    Loop
						  </strong>
						  <span>
						    <span>Off</span>
						    <span>On</span>
						    <a></a>
						  </span>
					</label>
	       		</div>
	       	</div>
			<div class="row">
			    <div class="col-md-4">
			        <div id="videoFrame" title="TAU Webcast video player">
			            <a href="rtsp://vod.tau.ac.il:80/Courses/_definst_/mp4:0111/1216/0111121601-20152-12179.mp4">
			                <img src='./Content/Img/filmPlaceHolder.jpg'>
			            </a>
			        </div>
			        <div class="padding-div">
			        	    <button class="btn btn-primary" ng-click="keyPressedFromTextBox(0,4)">
					            Save
					        </button>
			        </div>
			         <div class="padding-div" ng-show="latestHash.length > 0">
			         	Your Hash Is: {{latestHash}} - <a href="/api/getLatestSubtitles/{{latestHash}}">Download</a>
			         </div>
				</div>

				<div class="col-md-8" style="overflow-y: scroll; height:400px;">
					<table class="table">
					    <thead>
					      <tr>
					        <th class="col-md-1">Start Time</th>
					        <th class="col-md-1">End Time</th>
					        <th class="col-md-10">Text</th>
					      </tr>
					    </thead>
					    <tbody>
					      <tr class="success" ng-repeat="sub in subtitles track by $index">
					        <td ng-click="timeClick(sub.startTime)" onmouseover="" style="cursor: pointer;">{{ticksToTimeString(sub.startTime)}}</td>
					        <td>{{ticksToTimeString(sub.endTime)}}</td>
					        <td><input type="text" class="form-control" maxlength="80" ng-model="sub.txt" ng-click="subClick($index)" my-enter="keyPressedFromTextBox($index" ></td>
					      </tr>
					    </tbody>
					  </table>
				</div>
			</div>
	  </div>
	</div>
</body>
</html>


<script type="text/javascript">
	var playerInstance = jwplayer("videoFrame");


	var getQueryVariable = function(variable) {
	    var query = window.location.search.substring(1);
	    var vars = query.split('&');
	    for (var i = 0; i < vars.length; i++) {
	        var pair = vars[i].split('=');
	        if (decodeURIComponent(pair[0]) == variable) {
	            return decodeURIComponent(pair[1]);
	        }
	    }
	}

	var videoId = getQueryVariable("id");
	var userId = getQueryVariable("user");
	
	// rtsp://vod.tau.ac.il:80/Courses/_definst_/mp4:1011/2106/1011210611-20152-12387.mp4
	// http://lool.tau.ac.il/index.html?user=yairlevi1&id=10112106112015212387

	// rtsp://vod.tau.ac.il:80/Courses/_definst_/mp4:1411/9108/1411910801-20152-12386.mp4
	// http://lool.tau.ac.il/index.html?user=yairlevi1&id=14119108012015212386

	var getVideoUrlFromParam = function(videoId){
		if (!videoId) {
			return "";
		}

		var baseUrl = "://vod.tau.ac.il:80/Courses/_definst_/mp4:";
		var part1 = videoId.substring(0,4);
		var part2 = videoId.substring(4,8);
		var part3 = videoId.substring(8,10);
		var part4 = videoId.substring(10,15);
		var part5 = videoId.substring(15,20);

		return baseUrl + part1 + "/" + part2 + "/" + part1 + part2 + part3 + "-" + part4 + "-" + part5 + ".mp4/";
	}

	var videoUrl = getVideoUrlFromParam(videoId);

	var rtmpUrl = "rtmp" + videoUrl + "playlist.m3u8";
	var httpUrl1 = "http" + videoUrl + "manifest.mpd";
	var httpUrl2 = "http" + videoUrl + "playlist.m3u8";

	if (navigator.userAgent.match(/android/i) != null){
	    playerInstance.setup({
	    	playlist: [{
	        file: rtmpUrl,
	        image: '/Content/Img/filmPlaceHolder.jpg',
	        type: 'mp4',
	        primary: 'html5'
	    	}]
	    });
	} else {
	    playerInstance.setup({
	    	playlist: [{
	        file: httpUrl1,
	        image: '/Content/Img/filmPlaceHolder.jpg',
	        autostart: 'false'
	    	}]
	    });
	    
	    jQuery('.reloadMovie').on('click', function(){
	        playerInstance.remove();
	        playerInstance.setup({
	        	playlist: [{
	            file: httpUrl2,
	            image: '/Content/Img/filmPlaceHolder.jpg',
	            primary: 'html5',
	            autostart: 'false',
	            controls: '1'
	        	}]
	        });
	    })

	    var trident = !!navigator.userAgent.match(/Trident\/7.0/);
	    var net = !!navigator.userAgent.match(/.NET4.0E/);
	    var IE11 = trident && net;
	    var IEold = ( navigator.userAgent.match(/MSIE/i) ? true : false );
	    var theVideo;
	    jwplayer().on('ready', function(){
	        theVideo = document.querySelector('video');
	        theVideo.defaultPlaybackRate = 1.0;
	        theVideo.playbackRate = 1.0;
	        if (jwplayer().getRenderingMode() == "flash"){
	            return;
	        }
	    });
	}

</script>